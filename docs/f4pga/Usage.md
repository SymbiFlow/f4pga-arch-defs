# Using sfbuild to build a target

To build a **target** "`target_name`", use the following command:
```
$ python3 /path/to/sfbuild.py flow.json -p platform_device_name -t target_name
```
where `flow.json` is a path to **projects's flow configuration**

For example, let's consider the following
**projects's flow configuration (flow.json)**:

```json
{
    "dependencies": {
        "sources": ["counter.v"],
        "xdc": ["arty.xdc"],
        "synth_log": "synth.log",
        "pack_log": "pack.log",
        "top": "top"
    },
    "xc7a50t": {
        "dependencies": {
            "build_dir": "build/arty_35"
        }
    }
}
```

It specifies list of paths to Verilog source files as "`sources`" dependency.
Similarily it also provides an "`XDC`" file with constrains. ("`xdc`" dependency)

It also names a path for synthesis and logs ("`synth_log`", "`pack_log`").
These two are optional on-demand outputs, meaning they won't be produces unless
their paths are explicitely set.

"`top`" value is set to in order to specify the name of top Verilog module, which
is required during synthesis.

"`build_dir`" is an optional helper dependency. When available, modules will put
their outputs into that directory. It's also an _on-demand_ output of `mkdirs`
module in _xc7a50t_ flow definition, which means that if specified directory does
not exist, `mkdirs` will create it and provide as `build_dir` dependency.

building a bitstream for *x7a50t* would look like that:

With this flow configuration, you can build a bitstream for arty_35 using the
following command:

```
$ python3 /path/to/sfbuild.py flow.json -p x7a50t -t bitstream
```

## Pretend mode

You can also add a `--pretend` (`-P`) option if you just want to see the results of
dependency resolution for a specified target without building it. This is useful
when you just want to know what files will be generated and where wilh they be
stored.

## Info mode

Modules have the ability to include description to the dependencies they produce.

Running _**sfbuild**_ with `--info` (`-i`) flag allows youn to see descriptions of
these dependencies. This option doesn't require a target to be specified, but you
still have to provuide a flow configuration and platform name.

This is still an experimental option, most targets currently lack descriptions
and no information whether the output is _on-demand_ is currently displayed.

Example:
```
$ python3 /path/to/sfbuild.py flow.json -p x7a50t -i
```
```
Platform dependencies/targets:
    build_dir:          <no descritption>
                        module: `mk_build_dir`
    eblif:              Extended BLIF hierarchical sequential designs file
                        generated by YOSYS
                        module: `synth`
    fasm_extra:         <no description>
                        module: `synth`
    json:               JSON file containing a design generated by YOSYS
                        module: `synth`
    synth_json:         <no description>
                        module: `synth`
    sdc:                <no description>
                        module: `synth`
```

_This is only a snippet of the entire output_

## Summary of all available sfbuild options

| long       | short | arguments              | description                                     |
|------------|:-----:|------------------------|-------------------------------------------------|
| --platform | -p    | device name            | Specify target device name (eg. x7a100t)        |
| --target   | -t    | target dependency name | Specify target to produce                       |
| --info     | -i    | -                      | Display information about available targets     |
| --pretend  | -P    | -                      | Resolve dependencies without executing the flow |

## Dependency resolution display

sfbuild displays some information about dependencies when requesting a target.

Here's an example of a possible output when trying to build `bitstream` target:
```
sfbuild: Symbiflow Build System
Scanning modules...

Project status:
    [R] bitstream:  bitstream -> build/arty_35/top.bit
    [O] build_dir:  build/arty_35
    [R] eblif:  synth -> build/arty_35/top.eblif
    [R] fasm:  fasm -> build/arty_35/top.fasm
    [R] fasm_extra:  synth -> build/arty_35/top_fasm_extra.fasm
    [R] io_place:  ioplace -> build/arty_35/top.ioplace
    [R] net:  pack -> build/arty_35/top.net
    [X] pcf:  MISSING
    [R] place:  place -> build/arty_35/top.place
    [R] place_constraints:  place_constraints -> build/arty_35/top.preplace
    [R] route:  route -> build/arty_35/top.route
    [R] sdc:  synth -> build/arty_35/top.sdc
    [N] sources:  ['counter.v']
    [O] xdc:  ['arty.xdc']

sfbuild: DONE
```

The letters in the boxes describe the status of a dependency which's name is next
to the box.

 * **X** - dependency unresolved. This isn't always a bad sign. Some dependencies
   are not required to, such as "`pcf`".
 * **U** - dependency unreachable. The dependency has a module that could produce
   it, but the module's dependencies are unresolved. This doesn't say whether the
   dependency was necessary or not.
 * **O** - dependency present, unchanged. This dependency is already built and is
   confirmed to stay unchanged during flow execution.
 * **N** - dependency present, new/changed. This dependency is already present on
   the persistent storage, but it was either missing earlier, or
   its content changed from the last time.
   (WARNING: it won't continue to be reported as "**N**" after a successful build of
   any target. This may lead to some false "**O**"s in some complex scenarios. This
   should be fixed in the future.)
 * **S** - depenendency not present, resolved. This dependency is not
  currently available on the persistent storage, however it will be produced within
  flow's execution.
 * **R** - depenendency present, resolved, requires rebuild. This dependency is
  currently available on the persistent storage, however it has to be rebuilt due
  to the changes in the project.

Additional info about a dependency will be displayed next to its name after a
colon:

* In case of dependencies that are to be built (**S**/**R**), there's a name of a
  module that will produce this dependency, followed by "`->`" and a path or list of
  paths to file(s)/directory(ies) that will be produced as this dependency.

* In case of dependencies which do not require execution of any modules, only
  a path or list of paths to file(s)/directory(ies) that will be displayed

* In case of unresolved dependencies (**X**), which are never produced by any
  module, a text sying "`MISSING`" will be displayed
* In case of unreachable dependencies, a name of such module  that could produce
  them will be displayed followed by "`-> ???`".

In the example above file `counter.v` has been modified and is now marked as
"**N**". This couses a bunch of other dependencies to be reqbuilt ("**R**").
`build_dir` and `xdc` were already present, so they are marked as "**O**".
